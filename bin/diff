#!/bin/sh

set -e

HOST=${HOST:-pi}

# why do I need --build-host localhost? Shouldn't that be the default?
nixos-rebuild build \
    --fast \
    --flake .#pi-lix \
    --build-host localhost \
    --target-host $HOST \
    --use-remote-sudo  \
    2>&1 | nom

OUT_PATH=$(nix eval --raw \
    .#nixosConfigurations.pi-nix.config.system.build.toplevel.outPath
)
CURRENT_SYSTEM=$(ssh $HOST readlink /run/current-system)

#echo "OUT_PATH: $OUT_PATH"
#echo "CURRENT_SYSTEM: $CURRENT_SYSTEM"

# fetch the current system closure, so I can diff it
nix copy --from ssh://$HOST $CURRENT_SYSTEM

# package level diff
nix run nixpkgs#nvd -- diff $CURRENT_SYSTEM $OUT_PATH

# file level diff
nix run nixpkgs#nix-diff -- \
      $CURRENT_SYSTEM \
      $OUT_PATH \
      --color always
# nix-diff: unknown-deriver: withBinaryFile: does not exist (No such file or directory)
